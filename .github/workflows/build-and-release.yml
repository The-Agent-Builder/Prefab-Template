name: Build and Release Prefab

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0)

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„äº§

jobs:
  validate-build-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        run: uv python install 3.11
      
      - name: å®‰è£…ä¾èµ–
        run: uv sync --dev
      
      # ==================== éªŒè¯é˜¶æ®µ ====================
      
      - name: è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
        run: |
          echo "ğŸ” è¿è¡Œ Flake8 ä»£ç é£æ ¼æ£€æŸ¥..."
          uv run --with flake8 flake8 src/ --max-line-length=120 --exclude=__pycache__,*.pyc
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯• (Pytest)
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          uv run --with pytest pytest tests/ -v
      
      - name: éªŒè¯ Manifest ä¸ä»£ç ä¸€è‡´æ€§
        run: |
          echo "ğŸ” éªŒè¯ prefab-manifest.json ä¸ src/main.py çš„ä¸€è‡´æ€§..."
          uv run python scripts/validate_manifest.py
      
      - name: éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
        run: |
          echo "ğŸ” éªŒè¯ Git Tag ä¸ manifest ç‰ˆæœ¬å·ä¸€è‡´æ€§..."
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          MANIFEST_VERSION=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['version'])")
          
          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "âŒ é”™è¯¯: Git Tag ç‰ˆæœ¬ ($TAG_VERSION) ä¸ manifest ç‰ˆæœ¬ ($MANIFEST_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $TAG_VERSION"
      
      # ==================== æ„å»ºé˜¶æ®µ ====================
      
      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          echo "ğŸ“ åˆ›å»ºæ„å»ºç›®å½•..."
          mkdir -p build
      
      - name: å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        run: |
          echo "ğŸ“‹ å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶åˆ°æ„å»ºç›®å½•..."
          cp -r src build/
          cp prefab-manifest.json build/
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
      
      - name: ä¸‹è½½ä¾èµ–åˆ° vendor ç›®å½•
        run: |
          echo "ğŸ“¦ ä¸‹è½½è¿è¡Œæ—¶ä¾èµ–..."
          # ä» pyproject.toml è¯»å–è¿è¡Œæ—¶ä¾èµ–
          DEPS=$(python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
              deps = data.get('project', {}).get('dependencies', [])
              print(' '.join(deps) if deps else '')
          ")
          
          if [ -n "$DEPS" ]; then
            pip install --target=./build/vendor $DEPS
            echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
          else
            echo "â„¹ï¸  æ— è¿è¡Œæ—¶ä¾èµ–éœ€è¦ä¸‹è½½"
          fi
      
      # ==================== æ‰“åŒ…é˜¶æ®µ ====================
      
      - name: æ‰“åŒ…é¢„åˆ¶ä»¶
        id: package
        run: |
          echo "ğŸ“¦ æ‰“åŒ…é¢„åˆ¶ä»¶..."
          MANIFEST_ID=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['id'])")
          MANIFEST_VERSION=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['version'])")
          PACKAGE_NAME="${MANIFEST_ID}-${MANIFEST_VERSION}.tar.gz"
          
          cd build
          tar -czf "../${PACKAGE_NAME}" .
          cd ..
          
          echo "âœ… æ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}"
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "manifest_id=${MANIFEST_ID}" >> $GITHUB_OUTPUT
          echo "manifest_version=${MANIFEST_VERSION}" >> $GITHUB_OUTPUT
      
      - name: éªŒè¯æ‰“åŒ…æ–‡ä»¶
        run: |
          PACKAGE_NAME="${{ steps.package.outputs.package_name }}"
          echo "ğŸ” éªŒè¯æ‰“åŒ…æ–‡ä»¶: ${PACKAGE_NAME}"
          
          if [ ! -f "${PACKAGE_NAME}" ]; then
            echo "âŒ é”™è¯¯: æ‰“åŒ…æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z "${PACKAGE_NAME}" 2>/dev/null || stat -c%s "${PACKAGE_NAME}")
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: ${FILE_SIZE} bytes"
          
          echo "ğŸ“‹ åŒ…å†…å®¹:"
          tar -tzf "${PACKAGE_NAME}" | head -20
          
          echo "âœ… æ‰“åŒ…æ–‡ä»¶éªŒè¯é€šè¿‡"
      
      # ==================== å‘å¸ƒé˜¶æ®µ ====================
      
      - name: åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ é¢„åˆ¶ä»¶å‘å¸ƒ: ${{ steps.package.outputs.manifest_id }}
            
            **ç‰ˆæœ¬:** ${{ steps.package.outputs.manifest_version }}
            **æ ‡ç­¾:** ${{ github.ref_name }}
            
            ### ğŸ“¦ ä¸‹è½½
            ä¸‹è½½ä¸‹æ–¹çš„ `.tar.gz` æ–‡ä»¶å³å¯ä½¿ç”¨æ­¤é¢„åˆ¶ä»¶ã€‚
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md) äº†è§£è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚
            
            ---
            _æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ_
          draft: false
          prerelease: false
      
      - name: ä¸Šä¼ é¢„åˆ¶ä»¶åŒ…
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ steps.package.outputs.package_name }}
          asset_name: ${{ steps.package.outputs.package_name }}
          asset_content_type: application/gzip
      
      - name: å‘å¸ƒæˆåŠŸ
        run: |
          echo "ğŸ‰ é¢„åˆ¶ä»¶å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ åŒ…å: ${{ steps.package.outputs.package_name }}"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"

